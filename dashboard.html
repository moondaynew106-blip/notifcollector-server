<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NotifCollector Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f8fafc; color: #0f172a; padding: 20px; }
    h1 { margin: 0; font-size: 1.5rem; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    input { padding: 8px 10px; border-radius: 6px; border: 1px solid #ddd; width: 220px; }
    main { display: flex; gap: 20px; flex-wrap: wrap; }
    section { flex: 1 1 45%; background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    section h2 { margin: 0 0 10px; font-size: 1.1rem; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    .device { border-left: 6px solid; background: #fff; border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: 0.2s; }
    .device:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .online { border-color: #10b981; }
    .offline { border-color: #ef4444; opacity: 0.8; }
    .title { font-weight: 600; margin-bottom: 4px; }
    .meta { font-size: 13px; color: #64748b; }
    footer { margin-top: 20px; font-size: 13px; color: #64748b; }
    @media (max-width: 800px) { section { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <header>
    <h1>NotifCollector Dashboard</h1>
    <input id="search" placeholder="Search devices..." />
  </header>

  <main>
    <section>
      <h2>ðŸŸ¢ Online Devices</h2>
      <div id="online" class="grid"></div>
    </section>
    <section>
      <h2>ðŸ”´ Offline Devices</h2>
      <div id="offline" class="grid"></div>
    </section>
  </main>

  <footer>
    Click a device to open its control tab (one tab per device). Use <b>Fetch</b> or <b>Upload</b> to send commands.
  </footer>

  <script>
    const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host);
    const onlineEl = document.getElementById("online");
    const offlineEl = document.getElementById("offline");
    const searchEl = document.getElementById("search");

    let devices = {};

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "devices") {
        devices = msg.devices || {};
        render();
      } else if (msg.type === "response") {
        const win = window.open("", msg.clientId);
        if (win && win.pushLog) win.pushLog(msg.output);
      }
    };

    function render() {
      const query = searchEl.value.toLowerCase();
      const now = Date.now();
      const all = Object.entries(devices).map(([id, d]) => ({
        clientId: id,
        ...d,
        online: d.online ?? (now - (d.lastSeen || 0) < 15000)
      }));

      const online = all.filter(d => d.online && match(d));
      const offline = all.filter(d => !d.online && match(d));

      drawGrid(onlineEl, online, true);
      drawGrid(offlineEl, offline, false);
    }

    function match(d) {
      const q = searchEl.value.toLowerCase();
      if (!q) return true;
      return (d.deviceName || "").toLowerCase().includes(q) || d.clientId.toLowerCase().includes(q);
    }

    function drawGrid(container, list, isOnline) {
      container.innerHTML = "";
      if (list.length === 0) {
        container.innerHTML = `<div class="meta">No ${isOnline ? "online" : "offline"} devices</div>`;
        return;
      }
      list.forEach(d => {
        const card = document.createElement("div");
        card.className = `device ${d.online ? "online" : "offline"}`;
        card.innerHTML = `
          <div class="title">${escapeHtml(d.deviceName || "(unnamed)")}</div>
          <div class="meta">ID: ${escapeHtml(d.clientId)}</div>
          <div class="meta">Last seen: ${timeAgo(d.lastSeen)}</div>
        `;
        card.onclick = () => openDeviceTab(d);
        container.appendChild(card);
      });
    }

    function openDeviceTab(d) {
      const win = window.open("", d.clientId);
      if (!win.document.body || win.document.body.innerHTML.trim() === "") {
        const name = escapeHtml(d.deviceName || d.clientId);
        win.document.open();
        win.document.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"><title>${name}</title>
<style>
body{font-family:system-ui;margin:20px;background:#f9fafb;color:#111;}
button{padding:8px 12px;border-radius:6px;border:none;margin-right:8px;cursor:pointer;color:#fff;font-weight:600;}
.fetch{background:#10b981;}
.upload{background:#2563eb;}
.close{background:#ef4444;}
#log{white-space:pre-wrap;background:#fff;border:1px solid #eee;padding:10px;border-radius:8px;margin-top:10px;min-height:180px;max-height:70vh;overflow:auto;font-family:monospace;font-size:13px;}
</style>
</head>
<body>
<h2>${name}</h2>
<p>ID: ${escapeHtml(d.clientId)}</p>
<button class="fetch" id="btnFetch">Fetch</button>
<button class="upload" id="btnUpload">Upload</button>
<button class="close" id="btnClose">Close</button>
<pre id="log">Ready.</pre>
<script>
const logEl = document.getElementById("log");
function pushLog(m){logEl.textContent+="\\n["+new Date().toLocaleTimeString()+"] "+m;logEl.scrollTop=logEl.scrollHeight;}
window.pushLog=pushLog;
async function sendCmd(cmd){
  pushLog("Sending "+cmd+"...");
  try{
    const r=await fetch("/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({targetClientId:"${d.clientId}",command:cmd})});
    if(!r.ok) pushLog("Failed: "+r.status);
    else pushLog("Command sent âœ…");
  }catch(e){pushLog("Network error: "+e.message);}
}
document.getElementById("btnFetch").onclick=()=>sendCmd("fetch");
document.getElementById("btnUpload").onclick=()=>sendCmd("upload");
document.getElementById("btnClose").onclick=()=>window.close();
</script>
</body>
</html>
        `);
        win.document.close();
      }
      win.focus();
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}
    function timeAgo(ts){if(!ts)return"never";const d=Math.floor((Date.now()-ts)/1000);if(d<60)return d+"s ago";if(d<3600)return Math.floor(d/60)+"m ago";return Math.floor(d/3600)+"h ago";}
    searchEl.oninput = render;
  </script>
</body>
</html>
