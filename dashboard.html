<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NotifCollector Dashboard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      color: #222;
    }

    header {
      background: #2f3640;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.3rem;
    }

    main {
      max-width: 700px;
      margin: 2rem auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    select, input, button {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #273c75;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #40739e;
    }

    #output {
      margin-top: 1rem;
      background: #f1f2f6;
      border-radius: 8px;
      padding: 1rem;
      white-space: pre-wrap;
      font-family: monospace;
      min-height: 120px;
      overflow-y: auto;
    }

    .device-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .online {
      background-color: #44bd32;
      box-shadow: 0 0 4px #44bd32;
    }

    .offline {
      background-color: #e84118;
      box-shadow: 0 0 4px #e84118;
    }
  </style>
</head>
<body>
  <header>NotifCollector Dashboard</header>
  <main>
    <h3>Connected Devices</h3>
    <select id="deviceSelect"></select>

    <div>
      <input type="text" id="commandInput" placeholder="Enter command (e.g., fetch)" />
      <button onclick="sendCommand()">Send</button>
    </div>

    <h3>Responses</h3>
    <div id="output"></div>
  </main>

  <script>
    const ws = new WebSocket(`ws://${location.host}`);
    const deviceSelect = document.getElementById("deviceSelect");
    const outputDiv = document.getElementById("output");

    let devices = {};

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "devices") {
        devices = data.devices;
        updateDeviceList();
      } else if (data.type === "response") {
        const name = devices[data.clientId]?.name || data.clientId;
        logOutput(`ðŸ’¬ ${name}: ${data.output}`);
      }
    };

    function updateDeviceList() {
      deviceSelect.innerHTML = "";
      const entries = Object.entries(devices);
      if (entries.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "(No devices connected)";
        deviceSelect.appendChild(opt);
        return;
      }

      for (const [id, dev] of entries) {
        const opt = document.createElement("option");
        opt.value = id;
        const dot = dev.online
          ? "ðŸŸ¢"
          : "ðŸ”´";
        opt.textContent = `${dot} ${dev.name} (${id})`;
        deviceSelect.appendChild(opt);
      }
    }

    async function sendCommand() {
      const targetClientId = deviceSelect.value;
      const command = document.getElementById("commandInput").value.trim();
      if (!targetClientId || !command) {
        alert("Please select a device and enter a command.");
        return;
      }
      const res = await fetch("/command", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targetClientId, command }),
      });
      const data = await res.json();
      logOutput(`ðŸ“¤ Sent '${command}' to ${targetClientId}`);
    }

    function logOutput(msg) {
      const ts = new Date().toLocaleTimeString();
      outputDiv.textContent += `[${ts}] ${msg}\n`;
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }
  </script>
</body>
</html>
