<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Panel</title>

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        background: #f5f5f5;
        font-family: Arial, sans-serif;
        overflow: hidden; /* no page scroll */
    }

    /* LEFT SIDEBAR */
    #sidebar {
        width: 260px;
        background: #1e293b;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    #sidebar h2 {
        margin-top: 0;
        color: #93c5fd;
    }

    #sidebar button {
        margin-top: 10px;
        padding: 10px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    #sidebar button:hover {
        background: #2563eb;
    }

    /* RIGHT SIDE WRAPPER */
    #rightWrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 10px;
        gap: 10px;
    }

    /* LOG PANEL (TOP RIGHT) */
    #logPanel {
        flex: 0 0 40%;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: auto;
    }

    #logPanel h3 {
        margin-top: 0;
    }

    /* SCREENSHOTS PANEL (BOTTOM RIGHT) */
    #screenshotPanel {
        flex: 1;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: auto;
    }

    #screenshotGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
    }

    .shotItem {
        background: #f9fafb;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .shotItem img {
        width: 100%;
        height: auto;
        border-radius: 6px;
    }

    .timestamp {
        font-size: 12px;
        margin-top: 5px;
        color: #555;
    }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <h2>Device Control</h2>

    <button onclick="takeScreenshot()">ðŸ“¸ Capture Screenshot</button>
    <button onclick="sendTest()">âž¡ Send Test Command</button>

    <h3 style="margin-top:20px;">Device Info</h3>
    <div id="deviceInfo">Client: <b id="clientIdLabel"></b></div>
</div>

<!-- RIGHT PANELS -->
<div id="rightWrapper">

    <!-- LOG PANEL -->
    <div id="logPanel">
        <h3>Live Logs</h3>
        <div id="logs"></div>
    </div>

    <!-- SCREENSHOT PANEL -->
    <div id="screenshotPanel">
        <h3>Screenshots</h3>
        <div id="screenshotGrid"></div>
    </div>

</div>

<script>
const clientId = new URLSearchParams(window.location.search).get("id");
document.getElementById("clientIdLabel").textContent = clientId;

function pushLog(msg) {
    const logs = document.getElementById("logs");
    const line = document.createElement("div");
    line.textContent = msg;
    logs.appendChild(line);
    logs.scrollTop = logs.scrollHeight;
}

/* SIMULATED MQTT MESSAGE LISTENER */
function onMessage(msg) {
    if (msg.type === "response" && msg.clientId === clientId) {

        pushLog("ðŸ“© Response: " + msg.output);

        if (msg.output.includes("supabase.co")) {
            const url = msg.output.trim();
            addScreenshot(url);
        }
    }
}

/* ADD SCREENSHOT TO GRID */
function addScreenshot(url) {
    const grid = document.getElementById("screenshotGrid");

    const item = document.createElement("div");
    item.className = "shotItem";

    const img = document.createElement("img");
    img.src = url;

    // click to zoom in new tab
    img.onclick = () => {
        const w = window.open("", "_blank");
        w.document.write(`<img src="${url}" style="width:100%;height:auto;">`);
    };

    const t = document.createElement("div");
    t.className = "timestamp";
    const d = new Date();
    t.textContent = d.toLocaleString();

    // click on item => download automatically
    item.onclick = async () => {
        try {
            const res = await fetch(url);
            const blob = await res.blob();

            const blobUrl = URL.createObjectURL(blob);

            const stamp = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}-${d.getSeconds()}`;

            const link = document.createElement("a");
            link.href = blobUrl;
            link.download = `screenshot_${stamp}.jpg`;
            link.click();
            URL.revokeObjectURL(blobUrl);
        } catch (e) {
            console.error("Download failed", e);
        }
    };

    item.appendChild(img);
    item.appendChild(t);

    grid.prepend(item); // newest first
}

/* Example control */
function takeScreenshot() {
    pushLog("ðŸ“¤ Sending screenshot request...");
    // your MQTT publish logic here
}

function sendTest() {
    pushLog("ðŸ“¤ Sending test command...");
}

</script>

</body>
</html>
